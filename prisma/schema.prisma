generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(cuid())
  name        String
  email       String    @unique
  phone       String?
  password    String
  role        String    @default("CLIENT")
  image       String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  bookings    Booking[]
  payments    Payment[]
  reviews     Review[]
  ownedSalons Salon[]
}

model Salon {
  id           String    @id @default(cuid())
  name         String
  description  String?
  address      String
  phone        String
  email        String?
  logo         String?
  openTime     String
  closeTime    String
  workDays     String
  active       Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  ownerId      String
  bookingType  String    @default("BOTH")
  city         String?
  coverPhoto   String?
  featured     Boolean   @default(false)
  latitude     Float?
  longitude    Float?
  photos       String[]  @default([])
  publishedAt  DateTime?
  rating       Float     @default(0)
  reviewsCount Int       @default(0)
  specialties  String[]  @default([])
  state        String?
  verified     Boolean   @default(false)
  zipCode      String?
  bookings     Booking[]
  reviews      Review[]
  owner        User      @relation(fields: [ownerId], references: [id])
  services     Service[]
  staff        Staff[]
}

model Staff {
  id             String         @id @default(cuid())
  name           String
  email          String?
  phone          String?
  photo          String?
  specialty      String?
  active         Boolean        @default(true)
  workDays       String?        @default("1,2,3,4,5")
  workStart      String?        @default("09:00")
  workEnd        String?        @default("18:00")
  lunchStart     String?
  lunchEnd       String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  salonId        String
  availabilities Availability[]
  bookings       Booking[]
  services       ServiceStaff[]
  salon          Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
}

model Service {
  id          String         @id @default(cuid())
  name        String
  description String?
  duration    Int
  price       Float
  category    String?
  image       String?
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  salonId     String
  bookings    Booking[]
  salon       Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  staff       ServiceStaff[]
}

model ServiceStaff {
  id        String  @id @default(cuid())
  serviceId String
  staffId   String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  staff     Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([serviceId, staffId])
}

model Booking {
  id            String         @id @default(cuid())
  date          DateTime
  status        String         @default("PENDING")
  notes         String?
  totalPrice    Float
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  clientId      String
  salonId       String
  serviceId     String
  staffId       String
  client        User           @relation(fields: [clientId], references: [id])
  salon         Salon          @relation(fields: [salonId], references: [id], onDelete: Cascade)
  service       Service        @relation(fields: [serviceId], references: [id])
  staff         Staff          @relation(fields: [staffId], references: [id])
  notifications Notification[]
  payment       Payment?
  review        Review?

  @@index([date])
  @@index([clientId])
  @@index([salonId])
}

model Notification {
  id        String    @id @default(cuid())
  type      String
  sentAt    DateTime?
  status    String    @default("PENDING")
  bookingId String
  createdAt DateTime  @default(now())
  email     String
  error     String?
  subject   String?
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
  @@index([type])
  @@index([status])
}

model Payment {
  id                    String        @id @default(cuid())
  amount                Float
  status                String        @default("PENDING")
  method                String?
  stripeSessionId       String?       @unique
  stripePaymentIntentId String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  bookingId             String        @unique
  userId                String
  cancelledAt           DateTime?
  currency              String        @default("BRL")
  mercadopagoId         String?
  metadata              String?
  paidAt                DateTime?
  provider              String        @default("STRIPE")
  booking               Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user                  User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  transactions          Transaction[]

  @@index([status])
  @@index([provider])
  @@index([createdAt])
  @@index([userId])
}

model Transaction {
  id           String    @id @default(cuid())
  amount       Float
  status       String
  metadata     String?
  createdAt    DateTime  @default(now())
  paymentId    String
  errorCode    String?
  errorMessage String?
  externalId   String?
  method       String?
  processedAt  DateTime?
  payment      Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([paymentId])
  @@index([status])
  @@index([externalId])
}

model Availability {
  id        String    @id @default(cuid())
  date      DateTime?
  dayOfWeek Int?
  startTime String
  endTime   String
  available Boolean   @default(true)
  type      String    @default("BLOCK")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  staffId   String
  createdBy String?
  reason    String?
  staff     Staff     @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([staffId])
  @@index([date])
  @@index([dayOfWeek])
  @@index([staffId, date])
  @@index([staffId, dayOfWeek])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  salonId   String
  userId    String
  bookingId String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  booking   Booking? @relation(fields: [bookingId], references: [id])
  salon     Salon    @relation(fields: [salonId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([salonId])
  @@index([userId])
  @@index([rating])
  @@index([salonId, rating])
}
